!function(){"use strict";const e="add_collection_data",t="default_add_collection_data",o="custom_add_collection_data";const r=new class{db;dbName;storeName;dbVersion;constructor(e,t,o){this.dbName=e,this.storeName=t,this.dbVersion=o||1}open(){return this.db?Promise.resolve(this.db):new Promise((e,t)=>{const o=indexedDB.open(this.dbName,this.dbVersion);o.onerror=e=>{t(e.target.error)},o.onsuccess=t=>{this.db=t.target.result,e(this.db)},o.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(this.storeName)){t.createObjectStore(this.storeName,{keyPath:"id"}).createIndex("id","id",{unique:!0})}}})}close(){this.db&&(this.db.close(),this.db=void 0)}async _getStore(e){return(await this.open()).transaction(this.storeName,e).objectStore(this.storeName)}async add(e){const t=await this._getStore("readwrite");return new Promise((o,r)=>{const a=t.add({...e,updateTime:Date.now()});a.onsuccess=e=>o(e.target.result),a.onerror=e=>r(e.target.error)})}async get(e){const t=await this._getStore("readonly");return new Promise((o,r)=>{const a=t.get(e);a.onsuccess=e=>o(e.target.result),a.onerror=e=>r(e.target.error)})}async getAll(){const e=await this._getStore("readonly");return new Promise((t,o)=>{const r=e.getAll();r.onsuccess=e=>t(e.target.result),r.onerror=e=>o(e.target.error)})}async update(e){const t=await this._getStore("readwrite");return new Promise((o,r)=>{const a=t.put({...e,updateTime:Date.now()});a.onsuccess=e=>o(e.target.result),a.onerror=e=>r(e.target.error)})}async delete(e){const t=await this._getStore("readwrite");return new Promise((o,r)=>{const a=t.delete(e);a.onsuccess=()=>o(!0),a.onerror=e=>r(e.target.error)})}}("omni-seek_db","omni-seek_store");var a=(e=>(e.GET_ALL_COLLECTION_DATA="get_all_collection_data",e.ADD_COLLECTION_DATA="add_collection_data",e.OPEN_CUSTOM_ADD_COLLECTION_DATA_PAGE="open_custom_add_collection_data_page",e))(a||{});const n=async(e,t)=>{await chrome.windows.update(t.windowId,{focused:!0}),await(async(e,t)=>{await chrome.storage.local.set({[e]:t})})("custom_add_collection_data",e),await chrome.action.openPopup({windowId:t.windowId})},s=async(e,t="提示")=>{await chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:t,message:e})},i=e=>({url:e.url,title:e.title,id:`${e.id}_${Date.now()}`,parentId:"",parentTitle:"",faviconURL:e.favIconUrl||""});chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:e,title:"添加到Omni收藏夹",contexts:["all"]}),chrome.contextMenus.create({id:t,title:"使用当前网站标题添加",parentId:e,contexts:["all"]}),chrome.contextMenus.create({id:o,title:"自定义名称添加",parentId:e,contexts:["all"]})})}),chrome.contextMenus.onClicked.addListener(async(e,a)=>{if(a){const c=i(a);e.menuItemId===t?r.add(c).then(()=>{s("添加成功")}):e.menuItemId===o&&await n(c,a)}}),chrome.commands.onCommand.addListener(e=>{e===a.OPEN_CUSTOM_ADD_COLLECTION_DATA_PAGE&&chrome.tabs.query({active:!0,currentWindow:!0}).then(e=>{const[t]=e;t?chrome.runtime.lastError||n(i(t),t):s("无法获取当前tab，请刷新重试")})}),chrome.runtime.onMessage.addListener(({type:e,data:t})=>{if("update_collection_data_message"===e){if(t.updateTime)return void r.update(t).then(()=>{s("操作成功")});r.add(t).then(()=>{s("操作成功")})}}),chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.type===a.GET_ALL_COLLECTION_DATA)return r.getAll().then(e=>{o({data:e})}),!0})}();
