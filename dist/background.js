!function(){"use strict";const e="bookmarks";const t=new class{db;open(){return this.db?Promise.resolve(this.db):new Promise((t,r)=>{const o=indexedDB.open("bookmark-search_db",1);o.onerror=e=>{r(e.target.error)},o.onsuccess=e=>{this.db=e.target.result,t(this.db)},o.onupgradeneeded=t=>{const r=t.target.result;if(!r.objectStoreNames.contains(e)){r.createObjectStore(e,{keyPath:"id"}).createIndex("id","id",{unique:!0})}}})}close(){this.db&&(this.db.close(),this.db=void 0)}async _getStore(t){return(await this.open()).transaction(e,t).objectStore(e)}async add(e){const t=await this._getStore("readwrite");return new Promise((r,o)=>{const n=t.add({...e,createdTime:Date.now()});n.onsuccess=e=>r(e.target.result),n.onerror=e=>o(e.target.error)})}async get(e){const t=await this._getStore("readonly");return new Promise((r,o)=>{const n=t.get(e);n.onsuccess=e=>r(e.target.result),n.onerror=e=>o(e.target.error)})}async getAll(){const e=await this._getStore("readonly");return new Promise((t,r)=>{const o=e.getAll();o.onsuccess=e=>t(e.target.result),o.onerror=e=>r(e.target.error)})}async update(e){const t=await this._getStore("readwrite");return new Promise((r,o)=>{const n=t.put(e);n.onsuccess=e=>r(e.target.result),n.onerror=e=>o(e.target.error)})}async delete(e){const t=await this._getStore("readwrite");return new Promise((r,o)=>{const n=t.delete(e);n.onsuccess=()=>r(!0),n.onerror=e=>o(e.target.error)})}},r=(e,t="提示")=>{chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:t,message:e})},o="add_temporary_data",n="add_default_data",a="add_custom_data",s="popup_type",c=e=>({url:e.url,title:e.title,id:`${e.id}_${Date.now()}`,parentId:"",parentTitle:"",faviconURL:e.favIconUrl||""}),d=(e,t)=>{chrome.storage.local.set({[s]:{...e,_t:Date.now()}}).then(()=>{chrome.action.openPopup({windowId:t.windowId})})};chrome.commands.onCommand.addListener(e=>{"add_temporary_bookmark"===e&&chrome.tabs.query({active:!0,currentWindow:!0}).then(e=>{const[t]=e;t?chrome.runtime.lastError||d(c(t),t):r("无法获取当前tab，请刷新重试")})}),chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:o,title:"添加到书签搜索项",contexts:["all"]}),chrome.contextMenus.create({id:n,title:"使用当前网站名称添加",parentId:o,contexts:["all"]}),chrome.contextMenus.create({id:a,title:"自定义名称添加",parentId:o,contexts:["all"]})})}),chrome.contextMenus.onClicked.addListener((e,o)=>{if(o){const s=c(o);e.menuItemId===n?t.add(s).then(()=>{r("添加成功")}):e.menuItemId===a&&d(s,o)}}),chrome.runtime.onMessage.addListener((e,r,o)=>{if("GET_USER_TEMPORARY_DATA"===e.type)return t.getAll().then(e=>{o({data:e})}),!0}),chrome.runtime.onMessage.addListener(({type:e,data:o})=>{if("SET_USER_TEMPORARY_DATA"===e){if(o.createdTime)return void t.update(o).then(()=>{r("修改成功")});t.add(o).then(()=>{r("保存成功")})}})}();
