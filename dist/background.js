!function(){"use strict";const e="bookmarks";const t=new class{db;open(){return this.db?Promise.resolve(this.db):new Promise((t,r)=>{const o=indexedDB.open("bookmark-search_db",1);o.onerror=e=>{r(e.target.error)},o.onsuccess=e=>{this.db=e.target.result,t(this.db)},o.onupgradeneeded=t=>{const r=t.target.result;if(!r.objectStoreNames.contains(e)){r.createObjectStore(e,{keyPath:"id"}).createIndex("id","id",{unique:!0})}}})}close(){this.db&&(this.db.close(),this.db=void 0)}async _getStore(t){return(await this.open()).transaction(e,t).objectStore(e)}async add(e){const t=await this._getStore("readwrite");return new Promise((r,o)=>{const n=t.add({...e,createdTime:Date.now()});n.onsuccess=e=>r(e.target.result),n.onerror=e=>o(e.target.error)})}async get(e){const t=await this._getStore("readonly");return new Promise((r,o)=>{const n=t.get(e);n.onsuccess=e=>r(e.target.result),n.onerror=e=>o(e.target.error)})}async getAll(){const e=await this._getStore("readonly");return new Promise((t,r)=>{const o=e.getAll();o.onsuccess=e=>t(e.target.result),o.onerror=e=>r(e.target.error)})}async update(e){const t=await this._getStore("readwrite");return new Promise((r,o)=>{const n=t.put(e);n.onsuccess=e=>r(e.target.result),n.onerror=e=>o(e.target.error)})}async delete(e){const t=await this._getStore("readwrite");return new Promise((r,o)=>{const n=t.delete(e);n.onsuccess=()=>r(!0),n.onerror=e=>o(e.target.error)})}};let r,o=2025;const n=(e,t="success")=>{r&&clearTimeout(r);const n=document.createElement("div");n.classList.add("__bookmark__notification"),"success"!==t&&n.classList.add(`is-${t}`),requestAnimationFrame(()=>{n.classList.add("is-show")}),n.innerText=e,n.style.zIndex=String(++o),document.body.appendChild(n),r=setTimeout(()=>{n.classList.remove("is-show"),n.classList.add("is-fadeout"),requestAnimationFrame(()=>{document.body.contains(n)&&document.body.removeChild(n)})},2e3)},s=async(e,t="提示")=>{await chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:t,message:e})},a="add_temporary_data",c="add_default_data",i="add_custom_data",d="popup_type",u=e=>({url:e.url,title:e.title,id:`${e.id}_${Date.now()}`,parentId:"",parentTitle:"",faviconURL:e.favIconUrl||""}),m=(e,t)=>{chrome.storage.local.set({[d]:{...e,_t:Date.now()}}).then(()=>{chrome.action.openPopup({windowId:t.windowId})})};chrome.commands.onCommand.addListener(e=>{"add_temporary_bookmark"===e&&chrome.tabs.query({active:!0,currentWindow:!0}).then(e=>{const[t]=e;t?chrome.runtime.lastError||m(u(t),t):n("无法获取当前tab，请刷新重试")})}),chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:a,title:"添加到书签搜索项",contexts:["all"]}),chrome.contextMenus.create({id:c,title:"使用当前网站名称添加",parentId:a,contexts:["all"]}),chrome.contextMenus.create({id:i,title:"自定义名称添加",parentId:a,contexts:["all"]})})}),chrome.contextMenus.onClicked.addListener((e,r)=>{if(r){const o=u(r);e.menuItemId===c?t.add(o).then(()=>{n("添加成功")}):e.menuItemId===i&&m(o,r)}}),chrome.runtime.onMessage.addListener((e,r,o)=>{if("GET_USER_TEMPORARY_DATA"===e.type)return t.getAll().then(e=>{o({data:e})}),!0}),chrome.runtime.onMessage.addListener(({type:e,data:r})=>{if("SET_USER_TEMPORARY_DATA"===e){if(r.createdTime)return void t.update(r).then(()=>{s("临时书签修改成功")});t.add(r).then(()=>{s("临时书签保存成功")})}})}();
